var play = true,
    width = $('.bgimages').width();

$('.bgimages').append('<%= escape_javascript render('bgimage_list') %>');

$(document).on('click', '[data-action="skip-to"]', function(evt) {
  evt.preventDefault();
  var img = $('.bgimages .image.active')
  img.removeClass('active')
  var target = $(this).data('target');
  $($('.bgimages .image')[target]).addClass('active')
}).on('click', '[data-behavior="play"]', function() {
  play = true
}).on('click', '[data-behavior="pause"]', function() {
  play = false
})

$('.bgimages .image').on('swipeleft', function(evt) {
  next_image(false, true)
}).on('swiperight', function(evt) {
  next_image(true, true)
}).on('movestart', function(evt) {
  // need this to handle swipe correctly
}).on('move', function(e) {
	var left = 100 * e.distX / width;
	// Move slides with the finger
	if (e.distX < 0) {
		$(this).css('left', left + '%').css('right', -left + '%');
	}
	if (e.distX > 0) {
		$(this).css('left', left + '%').css('right', -left + '%');
	}
}).on('moveend', function(e) {
	$(this).css('left', '').css('right', '');
});

$(document).keydown(function(evt) {
  switch(evt.which) {
  case 32:
    if(play) {
      $('[data-behavior="pause"]').click()
    } else {
      $('[data-behavior="play"]').click()
    }    
    break;
  case 37:
    next_image(true, true);
    break;
  case 39:
    next_image(false, true);
    break;
  }
})

var next_image = function(prev, force) {
  if (!force && !play) { return false; }
  var img = $('.bgimages .image.active')
  img.removeClass('active')
  if(force) {
    $('[data-behavior="pause"]').click()
    img.addClass('force');
  } else {
    $('.bgimages .force').removeClass('force');
  }
  
  var next = [];
  if (prev) {
    next = img.prev('.image')
    if (next.length == 0) {
      next = $('.bgimages .image:last')
    }
  } else {
    next = img.next('.image')
    if (force && next.length == 0) {
      next = $('.bgimages .image:first')
    }
  }
  
  if (next.length > 0) {
    next.addClass('active');
    if(force) { next.addClass('force'); }
  } else {
    top.location.reload();
  }
}

$(document).ready(function() {
  setInterval(next_image, 10000);
});
